<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h3 class="text-center mb-0">
                        <i class="bi bi-shield-lock"></i> Restablecer Contraseña
                    </h3>
                </div>
                <div class="card-body">
                    {{#if success}}
                    <div class="text-center">
                        <div class="mb-4">
                            <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
                        </div>
                        <h4 class="text-success mb-3">¡Contraseña Actualizada!</h4>
                        <div class="alert alert-success">
                            <i class="bi bi-shield-check me-2"></i>
                            Tu contraseña ha sido restablecida exitosamente
                        </div>
                        <p class="text-muted mb-4">
                            Ya puedes iniciar sesión con tu nueva contraseña.
                        </p>
                        <a href="/login" class="btn btn-primary btn-lg">
                            <i class="bi bi-box-arrow-in-right"></i> Ir al Login
                        </a>
                    </div>
                    {{else}}
                    {{#if validToken}}
                    <div class="text-center mb-4">
                        <div class="mb-3">
                            <i class="bi bi-person-lock text-success" style="font-size: 3rem;"></i>
                        </div>
                        <h5>Crear Nueva Contraseña</h5>
                        <p class="text-muted">
                            Para la cuenta: <strong class="text-primary">{{email}}</strong>
                        </p>
                    </div>

                    <div id="resetError" class="alert alert-danger d-none"></div>

                    <form id="resetPasswordForm">
                        <input type="hidden" id="token" value="{{token}}">

                        <div class="mb-3">
                            <label for="newPassword" class="form-label">
                                <i class="bi bi-lock"></i> Nueva Contraseña
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="newPassword" name="newPassword"
                                    minlength="6" placeholder="Mínimo 6 caracteres" required>
                                <button class="btn btn-outline-secondary" type="button"
                                    onclick="togglePassword('newPassword')">
                                    <i class="bi bi-eye" id="newPassword-icon"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i>
                                La contraseña debe tener al menos 6 caracteres
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="confirmPassword" class="form-label">
                                <i class="bi bi-lock-fill"></i> Confirmar Nueva Contraseña
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="confirmPassword" name="confirmPassword"
                                    minlength="6" placeholder="Repite la contraseña" required>
                                <button class="btn btn-outline-secondary" type="button"
                                    onclick="togglePassword('confirmPassword')">
                                    <i class="bi bi-eye" id="confirmPassword-icon"></i>
                                </button>
                            </div>
                            <div id="passwordMatch" class="form-text"></div>
                        </div>

                        <div class="mb-3">
                            <div class="password-strength">
                                <label class="form-label small">Fortaleza de la contraseña:</label>
                                <div class="progress" style="height: 8px;">
                                    <div id="passwordStrength" class="progress-bar" role="progressbar"
                                        style="width: 0%"></div>
                                </div>
                                <small id="strengthText" class="text-muted"></small>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-success w-100 btn-lg" id="resetBtn">
                            <span id="resetSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                            <i class="bi bi-shield-check"></i> Restablecer Contraseña
                        </button>
                    </form>
                    {{else}}
                    <div class="text-center">
                        <div class="mb-4">
                            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 4rem;"></i>
                        </div>
                        <h4 class="text-warning mb-3">Enlace Inválido</h4>
                        <div class="alert alert-warning">
                            <i class="bi bi-clock-history me-2"></i>
                            {{#if error}}{{error}}{{else}}El enlace de recuperación ha expirado o es inválido{{/if}}
                        </div>
                        <p class="text-muted mb-4">
                            Los enlaces de recuperación expiran después de 1 hora por seguridad.
                        </p>
                        <a href="/request-password-reset" class="btn btn-primary btn-lg">
                            <i class="bi bi-arrow-repeat"></i> Solicitar Nuevo Enlace
                        </a>
                    </div>
                    {{/if}}
                    {{/if}}

                    <div class="text-center mt-4">
                        <hr>
                        <a href="/login" class="text-decoration-none">
                            <i class="bi bi-arrow-left"></i> Volver al Login
                        </a>
                    </div>
                </div>
            </div>

            {{#if validToken}}
            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="bi bi-shield-exclamation text-info"></i> Consejos de Seguridad
                    </h6>
                    <small class="text-muted">
                        • Usa una contraseña única para esta cuenta<br>
                        • Combina letras, números y símbolos<br>
                        • No uses información personal obvia<br>
                        • Considera usar un gestor de contraseñas
                    </small>
                </div>
            </div>
            {{/if}}
        </div>
    </div>
</div>

<script>
    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(inputId + '-icon');

        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
        }
    }

    function checkPasswordStrength(password) {
        let strength = 0;
        let text = '';
        let color = '';

        if (password.length >= 6) strength += 1;
        if (password.length >= 8) strength += 1;
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 1;
        if (/[0-9]/.test(password)) strength += 1;
        if (/[^A-Za-z0-9]/.test(password)) strength += 1;

        switch (strength) {
            case 0:
            case 1:
                text = 'Muy débil';
                color = 'bg-danger';
                break;
            case 2:
                text = 'Débil';
                color = 'bg-warning';
                break;
            case 3:
                text = 'Regular';
                color = 'bg-info';
                break;
            case 4:
                text = 'Fuerte';
                color = 'bg-success';
                break;
            case 5:
                text = 'Muy fuerte';
                color = 'bg-success';
                break;
        }

        const progressBar = document.getElementById('passwordStrength');
        const strengthText = document.getElementById('strengthText');

        if (progressBar && strengthText) {
            progressBar.className = `progress-bar ${color}`;
            progressBar.style.width = `${(strength / 5) * 100}%`;
            strengthText.textContent = text;
        }
    }

    function checkPasswordMatch() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const matchDiv = document.getElementById('passwordMatch');

        if (confirmPassword.length > 0) {
            if (newPassword === confirmPassword) {
                matchDiv.innerHTML = '<i class="bi bi-check-circle text-success"></i> Las contraseñas coinciden';
                matchDiv.className = 'form-text text-success';
            } else {
                matchDiv.innerHTML = '<i class="bi bi-x-circle text-danger"></i> Las contraseñas no coinciden';
                matchDiv.className = 'form-text text-danger';
            }
        } else {
            matchDiv.innerHTML = '';
        }
    }

    document.getElementById('newPassword')?.addEventListener('input', function () {
        checkPasswordStrength(this.value);
        checkPasswordMatch();
    });

    document.getElementById('confirmPassword')?.addEventListener('input', checkPasswordMatch);

    document.getElementById('resetPasswordForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const token = document.getElementById('token').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const resetBtn = document.getElementById('resetBtn');
        const resetSpinner = document.getElementById('resetSpinner');
        const resetError = document.getElementById('resetError');

        if (newPassword !== confirmPassword) {
            resetError.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Las contraseñas no coinciden';
            resetError.classList.remove('d-none');
            return;
        }

        if (newPassword.length < 6) {
            resetError.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>La contraseña debe tener al menos 6 caracteres';
            resetError.classList.remove('d-none');
            return;
        }

        try {
            resetSpinner.classList.remove('d-none');
            resetBtn.disabled = true;
            resetError.classList.add('d-none');
            resetBtn.innerHTML = `
                <span class="spinner-border spinner-border-sm me-2"></span>
                Restableciendo...
            `;

            const response = await fetch('/api/sessions/reset-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ token, newPassword })
            });

            const result = await response.json();

            if (result.status === 'success') {
                if (typeof Toastify !== 'undefined') {
                    Toastify({
                        text: "¡Contraseña restablecida exitosamente!",
                        duration: 3000,
                        gravity: "bottom",
                        position: "right",
                        style: { background: "linear-gradient(to right, #00b09b, #96c93d)" }
                    }).showToast();
                }

                document.querySelector('.card-body').innerHTML = `
                    <div class="text-center">
                        <div class="mb-4">
                            <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
                        </div>
                        <h4 class="text-success mb-3">¡Contraseña Actualizada!</h4>
                        <div class="alert alert-success">
                            <i class="bi bi-shield-check me-2"></i>
                            ${result.message}
                        </div>
                        <p class="text-muted mb-4">
                            Tu contraseña ha sido restablecida exitosamente. Ya puedes iniciar sesión.
                        </p>
                        <a href="/login" class="btn btn-primary btn-lg">
                            <i class="bi bi-box-arrow-in-right"></i> Ir al Login
                        </a>
                    </div>
                `;
            } else {
                throw new Error(result.message || 'Error del servidor');
            }
        } catch (error) {
            console.error('Error:', error);

            let errorMessage = 'Error al restablecer contraseña. Intenta de nuevo.';
            if (error.message) {
                errorMessage = error.message;
            }

            resetError.innerHTML = `
                <i class="bi bi-exclamation-triangle me-2"></i>
                ${errorMessage}
            `;
            resetError.classList.remove('d-none');

            if (typeof Toastify !== 'undefined') {
                Toastify({
                    text: errorMessage,
                    duration: 4000,
                    gravity: "bottom",
                    position: "right",
                    style: { background: "linear-gradient(to right, #ff5f6d, #ffc371)" }
                }).showToast();
            }
        } finally {
            resetSpinner.classList.add('d-none');
            resetBtn.disabled = false;
            resetBtn.innerHTML = `
                <i class="bi bi-shield-check"></i> Restablecer Contraseña
            `;
        }
    });
</script>